#!/usr/bin/env bun
// vim: ft=typescript

import { $ } from 'bun'
import { styleText } from 'node:util'
import ansiEscapes from 'ansi-escapes@7.1.1'
import { relative, normalize } from 'node:path';

const [{ name, owner: { login: owner } }, { number }] = await Promise.all([
  $`gh repo view --json name,owner`.json(),
  $`gh pr view --json number`.json()
]);

const { data } = await $`gh api graphql -F repo=${name} -F owner=${owner} -F number=${number} --paginate -f query='
  query MyQuery($owner:String!, $repo:String!, $number:Int!, $endCursor:String) {
    repository(owner:$owner, name:$repo) {
      pullRequest(number:$number) {    
        reviewThreads(first: 100, after: $endCursor) {
          nodes {
            isResolved
            path
            startLine
            line
            id
            comments(last:100) {
              nodes {
                author {
                  login
                }
                url
                bodyText
                createdAt
              }
            }
          }
          pageInfo {
            hasNextPage
            endCursor
          }
        }
      }
    }
  }
'`.json()

const gitroot: string = await $`git rev-parse --show-toplevel`.text().then(x => x.trim())
const cwd: string = process.cwd()

let first = true
for (const thread of data?.repository?.pullRequest?.reviewThreads?.nodes ?? []) {
  if (thread.isResolved) continue;
  if (!first) {
    console.log()
  }
  first = false
  let path = relative(cwd, `${gitroot}/${thread.path}`)
  path = styleText("cyan", styleText("dim", "> ") + path)
  if (thread.line) {
    let line = `L${thread.line}`;
    if (thread.startLine && thread.startLine !== thread.line) {
      line = `L${thread.startLine}-${thread.line}`
    }
    path += ` ${styleText("magenta", line)}`
  }
  if (thread.comments.nodes[0]) {
    // path = format(`\u001B[4:5m%s${styleText("reset", "")}`, path)
    path += `${styleText("dim", "â†—")}`
    path = ansiEscapes.link(path, thread.comments.nodes[0].url)
  }
  console.log([
    path,
    ...thread.comments.nodes.map(comment => {
      let author = styleText("green", `${styleText("dim", "<@")}${comment.author.login}${styleText("dim", ">")}`)
      return `${author} ${comment.bodyText.replace(/\r?\n/g, '\n> ')}`.trim()
    })
  ].join("\n"))
}
